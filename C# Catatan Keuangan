using System;
using Npgsql;

namespace KafeKasir
{
    public class CatatanKeuangan
    {
        public static void DisplayFinancialRecords()
        {
            using (var conn = Database.GetConnection())
            {
                conn.Open();
                using (var cmd = new NpgsqlCommand("SELECT tanggal_catatan, pegawai_id_pegawai, pendapatan_id_pendapatan FROM catatan_keuangan", conn))
                {
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            DateTime tanggal = reader.GetDateTime(0);
                            int pegawaiId = reader.GetInt32(1);
                            int pendapatanId = reader.GetInt32(2);
                            Console.WriteLine($"{tanggal} - {pegawaiId} - {pendapatanId}");
                        }
                    }
                }
            }
        }

        public static void CreateFinancialRecord(int userId)
        {
            Console.Write("Masukkan tanggal (yyyy-mm-dd): ");
            DateTime tanggal = DateTime.Parse(Console.ReadLine());

            using (var conn = Database.GetConnection())
            {
                conn.Open();
                using (var cmd = new NpgsqlCommand("INSERT INTO catatan_keuangan (tanggal_catatan, pegawai_id_pegawai, pendapatan_id_pendapatan) VALUES (@tanggal, @pegawaiId, @pendapatanId)", conn))
                {
                    cmd.Parameters.AddWithValue("tanggal", tanggal);
                    cmd.Parameters.AddWithValue("pegawaiId", userId);
                    cmd.Parameters.AddWithValue("pendapatanId", GetPendapatanIdByDate(tanggal));
                    cmd.ExecuteNonQuery();
                }
            }
            Console.WriteLine("Catatan keuangan berhasil dibuat.");
        }

        private static int GetPendapatanIdByDate(DateTime tanggal)
        {
            using (var conn = Database.GetConnection())
            {
                conn.Open();
                using (var cmd = new NpgsqlCommand("SELECT id_pendapatan FROM pendapatan WHERE tanggal_pendapatan = @tanggal", conn))
                {
                    cmd.Parameters.AddWithValue("tanggal", tanggal);
                    var result = cmd.ExecuteScalar();
                    return result != null ? Convert.ToInt32(result) : 0;
                }
            }
        }
    }
}
